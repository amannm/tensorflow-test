<html>

<head>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/posenet"></script>
  <script src="./body-pix-patched.js"></script>
  <link href="./style.css" rel="stylesheet" type="text/css">
</head>

<body>
  <section class="config">
    <section class="parameters">
      <form>
        <label for="internalResolution">Internal Resolution Scale</label>
        <input type="number" id="internalResolution" name="internalResolution" min="0.25" max="1.0" step="0.25"
          value="0.5" oninput="this.form.internalResolutionRange.value=this.value" />
        <input type="range" name="internalResolutionRange" min="0.25" max="1" step="0.25" value="0.5"
          oninput="this.form.internalResolution.value=this.value" />
      </form>
      <form>
        <label for="segmentationThreshold">Segmentation Threshold</label>
        <input type="number" id="segmentationThreshold" name="segmentationThreshold" min="0.0" max="1.0" step="0.01"
          value="0.7" oninput="this.form.segmentationThresholdRange.value=this.value" />
        <input type="range" name="segmentationThresholdRange" min="0" max="1" step="0.01" value="0.7"
          oninput="this.form.segmentationThreshold.value=this.value" />
      </form>
      <form>
        <label for="poseKeypointThreshold">Pose Keypoint Threshold</label>
        <input type="number" id="poseKeypointThreshold" name="poseKeypointThreshold" min="0.0" max="1.0" step="0.01"
          value="0.1" oninput="this.form.poseKeypointThresholdRange.value=this.value" />
        <input type="range" name="poseKeypointThresholdRange" min="0" max="1" step="0.01" value="0.1"
          oninput="this.form.poseKeypointThreshold.value=this.value" />
      </form>
    </section>
    <section class="actions">
      <button id="reprocess">Reprocess</button>
      <input type="file" id="fileElem" multiple accept="image/*" style="display:none">
      <button id="fileSelect">Open...</button>
    </section>
  </section>
  <section class="outputs">
    <section id="imageInput"></section>
    <canvas id='canvas'></canvas>
  </section>
  <section class="files">
    <ul id="fileList"></ul>
  </section>
</body>
<script type="module">
  import { loadAndPredict } from './index.js';

  let currentFile = null;

  const reprocessButton = document.getElementById("reprocess");
  reprocessButton.addEventListener("click", (e) => {
    processCurrentFile();
  });

  const enableButton = () => {
    reprocessButton.innerHTML = "Reprocess";
    reprocessButton.disabled = false;
  };

  const disableButton = () => {
    reprocessButton.innerHTML = "Processing...";
    reprocessButton.disabled = true;
  };


  const canvas = document.getElementById("canvas");

  function processCurrentFile() {
    if (currentFile !== null) {
      disableButton();
      const imageToProcess = document.createElement("img");
      imageToProcess.src = URL.createObjectURL(currentFile);
      imageToProcess.onload = function () {
        const imageInput = document.getElementById("imageInput");
        imageInput.innerHTML = "";
        imageInput.appendChild(imageToProcess);
        const ctx = canvas.getContext("2d");
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        canvas.width = 0;
        canvas.height = 0;
        const internalResolutionInput = document.getElementById("internalResolution");
        const segmentationThresholdInput = document.getElementById("segmentationThreshold");
        const poseKeypointThresholdInput = document.getElementById("poseKeypointThreshold");
        loadAndPredict(imageToProcess, canvas, {
          internalResolution: parseFloat(internalResolutionInput.value),
          segmentationThreshold: parseFloat(segmentationThresholdInput.value),
          poseKeypointThreshold: parseFloat(poseKeypointThresholdInput.value)
        }).then(() => {
          URL.revokeObjectURL(imageToProcess.src);
          enableButton();
        })
      }
    }
  }

  const fileList = document.getElementById("fileList");

  function handleFiles() {
    fileList.innerHTML = "";
    currentFile = null;
    if (this.files.length > 0) {
      for (let i = 0; i < this.files.length; i++) {
        const file = this.files[i];
        const img = document.createElement("img");
        img.src = URL.createObjectURL(file);
        img.onload = function () {
          URL.revokeObjectURL(this.src);
        };
        img.onclick = () => {
          currentFile = file;
          processCurrentFile();
        };
        const li = document.createElement("li");
        li.appendChild(img);
        const info = document.createElement("span");
        //info.innerHTML = this.files[i].name + ": " + this.files[i].size + " bytes";
        li.appendChild(info);
        fileList.appendChild(li);
      }
    }
  }

  const fileElem = document.getElementById("fileElem");
  fileElem.addEventListener("change", handleFiles, false);
  const fileSelect = document.getElementById("fileSelect");
  fileSelect.addEventListener("click", function (e) {
    if (fileElem) {
      fileElem.click();
    }
    e.preventDefault();
  }, false);

</script>

</html>